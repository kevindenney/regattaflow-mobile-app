/**
 * Race Coaching Service
 *
 * Analyzes post-race responses using Bill Gladstone's North U frameworks
 * and provides personalized coaching feedback.
 *
 * Uses the race-strategy-analyst Claude Skill for expert tactical analysis.
 */

import Anthropic from '@anthropic-ai/sdk';
import * as fs from 'fs';
import * as path from 'path';
import type {
  RaceAnalysis,
  CoachingFeedback,
  FrameworkScores,
  BillGladstoneFramework,
  RacePhase,
} from '@/src/types/raceAnalysis';
import type { Race } from '@/src/types';

export class RaceCoachingService {
  private anthropic: Anthropic;
  private billFrameworks: BillGladstoneFrameworkData | null = null;

  constructor(apiKey?: string) {
    this.anthropic = new Anthropic({
      apiKey:
        apiKey ||
        process.env.ANTHROPIC_API_KEY ||
        process.env.EXPO_PUBLIC_ANTHROPIC_API_KEY,
    });
  }

  /**
   * Generate complete coaching feedback for a race analysis
   */
  async generateCoachingFeedback(
    analysis: RaceAnalysis,
    race: Race
  ): Promise<{
    coaching_feedback: CoachingFeedback[];
    framework_scores: FrameworkScores;
    overall_assessment: string;
    next_race_priorities: string[];
  }> {
    // Load Bill Gladstone frameworks if not already loaded
    if (!this.billFrameworks) {
      await this.loadBillGladstoneFrameworks();
    }

    const feedback: CoachingFeedback[] = [];
    const scores: FrameworkScores = {};

    // Analyze each phase where sailor provided responses

    // 1. Puff Response Framework
    if (analysis.upwind_puff_handling) {
      const puffFeedback = this.analyzePuffResponse(analysis);
      feedback.push(puffFeedback);
      scores.puff_response = this.calculatePuffResponseScore(
        analysis.upwind_puff_handling
      );
    }

    // 2. One-on-One Tactics (Delayed Tack)
    if (analysis.upwind_tactics_used && analysis.upwind_tactics_used.length > 0) {
      const tacticsFeedback = this.analyzeOneOnOneTactics(analysis);
      feedback.push(tacticsFeedback);
      scores.delayed_tack_usage = this.calculateDelayedTackScore(
        analysis.upwind_tactics_used
      );
    }

    // 3. Wind Shift Awareness
    if (analysis.upwind_shift_awareness) {
      const shiftFeedback = this.analyzeShiftAwareness(analysis);
      feedback.push(shiftFeedback);
      scores.shift_awareness = analysis.upwind_shift_awareness * 20; // Convert 1-5 to 0-100
    }

    // 4. Downwind Shift Detection
    if (analysis.downwind_shift_detection) {
      const downwindFeedback = this.analyzeDownwindDetection(analysis);
      feedback.push(downwindFeedback);
      scores.downwind_detection = this.calculateDownwindDetectionScore(
        analysis.downwind_shift_detection
      );
    }

    // 5. Getting In Phase (Windward Mark Approach)
    if (analysis.windward_mark_approach_tack) {
      const inPhaseFeedback = this.analyzeGettingInPhase(analysis);
      feedback.push(inPhaseFeedback);
      scores.getting_in_phase = this.calculateInPhaseScore(
        analysis.windward_mark_approach_tack,
        analysis.downwind_in_phase
      );
    }

    // 6. Covering/Breaking Cover Tactics (Steve Colgate Specialty)
    const coveringFeedback = this.analyzeCoveringTactics(analysis);
    if (coveringFeedback) {
      feedback.push(coveringFeedback);
      // Note: covering_tactics not in FrameworkScores but execution_score captures performance
      if (coveringFeedback.execution_score) {
        scores.covering_tactics = coveringFeedback.execution_score;
      }
    }

    // Calculate overall framework adoption score
    const scoreValues = Object.values(scores).filter((s) => s !== undefined) as number[];
    scores.overall_framework_adoption =
      scoreValues.length > 0
        ? Math.round(scoreValues.reduce((a, b) => a + b, 0) / scoreValues.length)
        : 0;

    // Generate overall assessment using Claude
    const overallAssessment = await this.generateOverallAssessment(
      analysis,
      feedback,
      scores,
      race
    );

    // Prioritize next race focus areas
    const nextRacePriorities = this.prioritizeNextRaceFocus(feedback, scores);

    return {
      coaching_feedback: feedback,
      framework_scores: scores,
      overall_assessment: overallAssessment,
      next_race_priorities: nextRacePriorities,
    };
  }

  /**
   * Analyze Puff Response (Bill's Signature: "TRIM response, not HELM response")
   */
  private analyzePuffResponse(analysis: RaceAnalysis): CoachingFeedback {
    const handling = analysis.upwind_puff_handling!;

    switch (handling) {
      case 'traveler':
        return {
          phase: 'upwind',
          bill_framework: 'Puff Response Framework',
          your_approach: 'You used traveler control to handle puffs',
          bill_recommendation:
            '‚úÖ Excellent! This is a TRIM response, not a HELM response. Traveler down when puff hits ‚Üí boat accelerates ‚Üí traveler back up. You\'re using championship-level technique!',

          // Execution Analysis
          colgate_execution_technique: 'Boat Control Mastery',
          execution_score: 90,
          execution_feedback:
            'üèÜ Boat control mastery is the foundation of racing. Championship sailors can hold position within 3 feet for minutes using traveler, weight, and centerboard. Your traveler control shows this awareness. Next level: Practice rapid traveler response - down BEFORE excessive heel, up AS boat accelerates.',
          champion_story:
            'Championship frostbite racers demonstrate this by keeping dinghies within 3 feet of committee boats in 12-15 knots using traveler control, weight movement, and centerboard adjustments while competitors drift off.',

          confidence: 95,
          impact: 'high',
          next_race_focus:
            'Focus on timing precision: traveler down BEFORE excessive heel develops. Feel the acceleration, then traveler up.',
          demo_reference: './racing-tactics 1',
        };

      case 'mainsheet':
        return {
          phase: 'upwind',
          bill_framework: 'Puff Response Framework',
          your_approach: 'You used mainsheet to ease and trim in puffs',
          bill_recommendation:
            '‚ö° Good instinct to use trim, but TRAVELER is more effective for moderate displacement keelboats. Mainsheet control works best for hot boats with tall rigs (J70, Melges). Traveler gives you better angle control while maintaining power.',
          confidence: 90,
          impact: 'medium',
          next_race_focus: 'Practice traveler down/up sequence in 10-15 knots',
          demo_reference: './racing-tactics 1',
        };

      case 'feathered':
        return {
          phase: 'upwind',
          bill_framework: 'Puff Response Framework',
          your_approach: 'You feathered (turned toward wind) when puffs hit',
          bill_recommendation:
            'üéØ This is a TRIM response, not a HELM response! Feathering is a helm response - it slows the boat. Instead, try TRAVELER DOWN when puff hits ‚Üí let boat accelerate ‚Üí TRAVELER UP. You\'ll maintain much higher boat speed through puffs.',
          confidence: 95,
          impact: 'high',
          next_race_focus:
            'Next race: Focus on keeping helm straight, use traveler to depower. Feel the difference in boat speed!',
          demo_reference: './racing-tactics 1',
        };

      case 'not_sure':
      default:
        return {
          phase: 'upwind',
          bill_framework: 'Puff Response Framework',
          your_approach: 'You weren\'t sure how you handled puffs',
          bill_recommendation:
            'üí° Championship puff response system: When puff hits ‚Üí TRAVELER DOWN ‚Üí boat accelerates ‚Üí TRAVELER UP. This is a "TRIM response, not a HELM response." Next race, focus on feeling each puff and consciously using traveler control.',
          confidence: 95,
          impact: 'high',
          next_race_focus: 'Practice identifying puffs and using traveler response',
          demo_reference: './racing-tactics 1',
        };
    }
  }

  /**
   * Analyze One-on-One Tactics (Delayed Tack Signature Move)
   */
  private analyzeOneOnOneTactics(analysis: RaceAnalysis): CoachingFeedback {
    const tactics = analysis.upwind_tactics_used || [];
    const usedDelayedTack = tactics.includes('delayed_tack');

    if (usedDelayedTack) {
      return {
        phase: 'upwind',
        bill_framework: 'Delayed Tack',
        your_approach: 'You used the Delayed Tack in 1-on-1 situations',
        bill_recommendation:
          'üèÜ Outstanding! You used Bill\'s SIGNATURE MOVE. The Delayed Tack (cross opponent ‚Üí sail SHORT distance <1 length ‚Üí THEN tack) is his most reliable tactical tip. Keep refining the execution - the goal is turning a 1-length lead into 3-4 lengths at the windward mark.',

        // Colgate Execution Analysis
        colgate_execution_technique: 'Tight Cover Timing (Colgate)',
        execution_score: 85,
        execution_feedback:
          'üéØ Steve Colgate\'s tight cover technique: Tack at RIGHT location/moment so you\'re dead on opponent\'s wind by time momentum picked up. Timing errors: Too late = they get safe leeward. Too early = they get safe leeward when they tack. Your delayed tack execution shows good timing awareness. Refine: Practice tacking closer (<1 length) for maximum geometric advantage.',
        champion_story:
          'Colgate covering principle: "Best starting skippers have complete control - know turning radius, stopping ability, acceleration rate." Delayed tack + tight cover timing = dominant one-on-one racing.',

        confidence: 90,
        impact: 'high',
        next_race_focus:
          'Focus on the SHORT distance (<1 length) and precise tack timing. Watch opponent\'s bow - tack when just past it.',
        demo_reference: './bill-demo 2',
      };
    }

    const usedCrossAndCover = tactics.includes('cross_and_cover');

    if (usedCrossAndCover) {
      return {
        phase: 'upwind',
        bill_framework: 'Delayed Tack',
        your_approach: `You used: ${tactics.join(', ')}`,
        bill_recommendation:
          'üí° Good tactical awareness! But consider Bill Gladstone\'s DELAYED TACK next time you cross an opponent. Instead of tacking immediately to cover, sail SHORT distance (<1 boat length), THEN tack. This creates better geometric advantage and can turn a 1-length lead into 3-4 lengths.',
        confidence: 90,
        impact: 'high',
        next_race_focus:
          'Look for crossing situations where you can execute delayed tack',
        demo_reference: './bill-demo 2',
      };
    }

    return {
      phase: 'upwind',
      bill_framework: 'Delayed Tack',
      your_approach: `You used: ${tactics.join(', ')}`,
      bill_recommendation:
        'üéØ Bill Gladstone\'s signature move is the DELAYED TACK. When you cross an opponent cleanly by 1 boat length: sail SHORT distance (less than 1 length), THEN tack to lee-bow position. This forces them into a no-win choice at the layline. Look for opportunities to practice this in your next race!',
      confidence: 90,
      impact: 'medium',
      next_race_focus: 'Watch for crossing opportunities to try delayed tack',
      demo_reference: './bill-demo 2',
    };
  }

  /**
   * Analyze Wind Shift Awareness
   */
  private analyzeShiftAwareness(analysis: RaceAnalysis): CoachingFeedback {
    const awareness = analysis.upwind_shift_awareness!;

    if (awareness >= 4) {
      return {
        phase: 'upwind',
        bill_framework: 'Wind Shift Mathematics',
        your_approach: `You rated your shift awareness as ${awareness}/5`,
        bill_recommendation:
          '‚úÖ Excellent shift awareness! Bill Gladstone quantifies this: "10¬∞ shift = 25% of boat separation." If two boats split for 2 minutes at 6 knots, a 10¬∞ shift creates a 9-boat-length advantage. Your strong awareness is race-winning!',

        // Colgate Execution Analysis
        colgate_execution_technique: 'Dick Stearns Shift Watching',
        execution_score: 85,
        execution_feedback:
          'üèÜ With your strong shift awareness, you\'re ready for Dick Stearns\' championship technique: When being covered, WATCH the covering boat\'s hull angle closely. When they appear lifted (boat looks higher/more bow up), tack immediately. They\'re sailing in header. The wind shift takes moments to travel down to leeward - you have heading advantage until the new wind reaches you. Repeat this over and over to eat up their lead.',
        champion_story:
          'Dick Stearns vs Tom Blackaller at Bacardi Cup Star Series: Despite Tom having good boat speed, Dick watched Tom\'s Star hull angle. When Tom lifted, Dick tacked. Tom tacked to cover but was in header. Shifty offshore 15 mph breeze - Dick had heading advantage until shift reached him. Repeated procedure over and over, ate up Tom\'s lead.',

        confidence: 95,
        impact: 'high',
        next_race_focus:
          'Track exact shift magnitudes and calculate the leverage you gained/lost. Practice Dick Stearns hull-angle watching when covered.',
        demo_reference: './bill-demo 3',
      };
    }

    if (awareness === 3) {
      return {
        phase: 'upwind',
        bill_framework: 'Wind Shift Mathematics',
        your_approach: `You rated your shift awareness as ${awareness}/5`,
        bill_recommendation:
          '‚ö° You have baseline awareness. Bill Gladstone teaches: "10¬∞ shift = 25% of boat separation." On a typical 2-minute split, that\'s 9 boat lengths! Focus on QUANTIFYING shifts - use compass on every tack. Small shifts (even 5¬∞) have massive impact.',

        // Colgate Execution Analysis
        colgate_execution_technique: 'Dick Stearns Shift Watching + Compass Discipline',
        execution_score: 70,
        execution_feedback:
          'üéØ Build your shift awareness with Dick Stearns\' technique: Watch other boats\' hull angles - when they appear lifted, you\'re seeing a shift before it reaches you. Combine this with compass discipline: Call out your upwind heading on EVERY tack. Write it down if possible. Pattern recognition develops from repetition.',
        champion_story:
          'Dick Stearns became known for shift awareness by watching hull angles religiously. "Wind shifts hit windward boat first" - he used this simple principle to break covers consistently.',

        confidence: 95,
        impact: 'high',
        next_race_focus:
          'Use compass religiously on every tack. Track shift patterns. Practice watching hull angles of boats ahead.',
        demo_reference: './bill-demo 3',
      };
    }

    return {
      phase: 'upwind',
      bill_framework: 'Wind Shift Mathematics',
      your_approach: `You rated your shift awareness as ${awareness}/5`,
      bill_recommendation:
        'üéØ Shift awareness is CRITICAL. Bill Gladstone: "10¬∞ shift = 25% of boat separation" - that means a 2-minute split can create 9 boat lengths gain/loss from a single shift! Priority #1 for next race: use compass on EVERY tack. Write down your upwind numbers.',

      // Colgate Execution Analysis - Teaching fundamentals
      colgate_execution_technique: 'Compass Discipline (Foundation for Shift Detection)',
      execution_score: 50,
      execution_feedback:
        'üìö Start building shift awareness with compass discipline: Call out your upwind heading EVERY time you tack. This is the foundation. Steve Colgate emphasizes: "Championship sailors ALWAYS know their numbers." Once you track numbers consistently, you\'ll start recognizing shift patterns naturally. Write headings on deck if helpful.',
      champion_story:
        'Every champion sailor from Dick Stearns to modern Olympic medalists started with compass discipline. No shortcuts - this is the foundation of tactical racing.',

      confidence: 95,
      impact: 'high',
      next_race_focus:
        'Get compass on boat. Track numbers on every tack. Start learning shift patterns. Call headings out loud to build habit.',
      demo_reference: './bill-demo 3',
    };
  }

  /**
   * Analyze Downwind Shift Detection
   */
  private analyzeDownwindDetection(analysis: RaceAnalysis): CoachingFeedback {
    const method = analysis.downwind_shift_detection!;

    switch (method) {
      case 'apparent_wind':
        return {
          phase: 'downwind',
          bill_framework: 'Downwind Shift Detection',
          your_approach: 'You used apparent wind feel to detect shifts downwind',
          bill_recommendation:
            'üèÜ Perfect! This is exactly Bill Gladstone\'s method! "Apparent wind goes AFT WITHOUT feeling stronger = TRUE LIFT ‚Üí JIBE IMMEDIATELY." You\'re using championship-level shift detection. The key signature: velocity change would feel STRONGER, but a pure lift goes aft without strength change.',

          // Colgate Execution Analysis
          colgate_execution_technique: 'Rhythmic Jibing with Telltale Awareness',
          execution_score: 85,
          execution_feedback:
            'üéØ Steve Colgate: Once you detect shift with apparent wind, execute smooth jibe maintaining speed. Championship technique: Keep telltales flowing through jibe, minimize rudder angle, crew weight movement synchronized. "Fast jibing = competitive downwind." Practice makes jibes automatic so you can focus on shift detection.',
          champion_story:
            'Colgate emphasizes: "Downwind shift detection paired with fast jibing separates good sailors from champions. Detect + Execute = Winning combination."',

          confidence: 85,
          impact: 'high',
          next_race_focus:
            'Keep refining this feel. Practice distinguishing puff vs lift. Work on jibe speed and smoothness.',
          demo_reference: './bill-demo 5',
        };

      case 'schooled_upwind_boats':
        return {
          phase: 'downwind',
          bill_framework: 'Downwind Shift Detection',
          your_approach: 'You watched upwind boats to detect shifts',
          bill_recommendation:
            '‚úÖ Smart! Upwind boats can see shifts with compass. But Bill Gladstone teaches a MORE IMMEDIATE method: apparent wind feel. "Apparent wind goes AFT WITHOUT getting stronger = LIFT ‚Üí JIBE." This lets you react instantly without waiting to see other boats.',

          // Colgate Execution Analysis
          colgate_execution_technique: 'Visual Shift Detection + Anticipatory Positioning',
          execution_score: 75,
          execution_feedback:
            'üéØ Watching upwind boats is good tactical awareness. Steve Colgate teaches: Combine this with anticipatory positioning - when you see upwind boats lift, prepare for jibe BEFORE shift reaches you. Set crew, trim spinnaker, get ready. When shift arrives, execute immediately. This combines observation with proactive execution.',

          confidence: 85,
          impact: 'medium',
          next_race_focus:
            'Practice feeling apparent wind direction shifts while watching upwind boats as confirmation. Prepare crew before shifts arrive.',
          demo_reference: './bill-demo 5',
        };

      case 'compass':
        return {
          phase: 'downwind',
          bill_framework: 'Downwind Shift Detection',
          your_approach: 'You used compass to detect downwind shifts',
          bill_recommendation:
            '‚ö° Compass works, but Bill teaches it\'s HARDER downwind. Better method: "Apparent wind goes AFT WITHOUT getting stronger = LIFT ‚Üí JIBE." This feel-based approach is faster and more reliable than watching compass downwind.',

          // Colgate Execution Analysis
          colgate_execution_technique: 'Transition from Compass to Feel-Based Detection',
          execution_score: 70,
          execution_feedback:
            'üìö Compass discipline shows good fundamentals. Steve Colgate progression: Start with compass (you\'re here), then add telltale awareness, then develop apparent wind feel. Practice this sequence: (1) Check compass, (2) Look at telltales, (3) Feel wind on face/ears. Over time, steps 2-3 become automatic and you react before checking compass.',

          confidence: 85,
          impact: 'medium',
          next_race_focus:
            'Practice feeling apparent wind shifts - supplement compass with this tactile feedback. Watch telltales during jibes.',
          demo_reference: './bill-demo 5',
        };

      case 'didnt_track':
      default:
        return {
          phase: 'downwind',
          bill_framework: 'Downwind Shift Detection',
          your_approach: 'You didn\'t actively track downwind shifts',
          bill_recommendation:
            'üéØ Bill Gladstone teaches: downwind sees 1-2 shifts per 15 minutes (upwind sees 3-4). Each shift is CRITICAL! His detection method: "Apparent wind goes AFT WITHOUT getting stronger = LIFT ‚Üí JIBE IMMEDIATELY." Start practicing this feel!',

          // Colgate Execution Analysis
          colgate_execution_technique: 'Building Downwind Awareness (Foundation)',
          execution_score: 50,
          execution_feedback:
            'üìö Steve Colgate: Start with basics - assign ONE crew to watch telltales continuously downwind. Call out when telltales change angle. This builds your team\'s awareness. Once telltale watching becomes habit, you\'ll naturally develop apparent wind feel. "Downwind shift detection is learnable skill, not magic."',

          confidence: 85,
          impact: 'high',
          next_race_focus:
            'Next race: Focus on feeling apparent wind direction changes downwind. Assign crew to call telltale changes.',
          demo_reference: './bill-demo 5',
        };
    }
  }

  /**
   * Analyze Getting In Phase (Windward Mark Approach)
   */
  private analyzeGettingInPhase(analysis: RaceAnalysis): CoachingFeedback {
    const approach = analysis.windward_mark_approach_tack!;
    const inPhase = analysis.downwind_in_phase;

    const isLifted =
      approach === 'starboard_lifted' || approach === 'port_lifted';

    if (isLifted && inPhase === true) {
      return {
        phase: 'windward_mark',
        bill_framework: 'Getting In Phase',
        your_approach:
          'You rounded on the lifted tack and felt in phase downwind',
        bill_recommendation:
          'üèÜ Textbook execution! Bill Gladstone: "Round windward mark on the LIFTED tack to set up entire downwind leg." You did exactly that and it paid off with good phase downwind. This is championship-level mark strategy!',

        // Colgate Execution Analysis
        colgate_execution_technique: 'Smooth Mark Rounding Mechanics',
        execution_score: 90,
        execution_feedback:
          'üèÜ Excellent strategic rounding! Now refine execution mechanics from Steve Colgate: As you round, minimize rudder angle (wide smooth arc), keep boat speed up through turn, set spinnaker when stable (not mid-turn). If rounding close behind boat, consider Bill Cox delayed spinnaker technique - sail close reach on main/jib to blanket leader, then set chute in controlling position.',
        champion_story:
          'Bill Cox (American Eagle 1968 America\'s Cup): Round weather mark close behind, delay spinnaker set, sail close reach with main/jib trimmed properly while boat ahead slows with crew bouncing around setting spinnaker. Get on their wind, making their spinnaker difficult to fly.',

        confidence: 90,
        impact: 'high',
        next_race_focus:
          'Keep this discipline - always check if you\'re lifted or headed approaching windward mark. Practice smooth rounding mechanics.',
        demo_reference: './bill-demo 6',
      };
    }

    if (isLifted && inPhase === false) {
      return {
        phase: 'windward_mark',
        bill_framework: 'Getting In Phase',
        your_approach:
          'You rounded on lifted tack but felt out of phase downwind',
        bill_recommendation:
          '‚ö° You executed Bill\'s approach (round on lifted) but still felt out of phase. Possible causes: (1) wind shifted just after rounding, (2) fleet forced you off course. Focus on maintaining your chosen jibe after rounding - don\'t let fleet push you out of phase.',

        // Colgate Execution Analysis
        colgate_execution_technique: 'Post-Rounding Commitment + Hans Fogh Reverse',
        execution_score: 75,
        execution_feedback:
          'üéØ Strategic approach was correct, execution needs refinement. Steve Colgate: After rounding, COMMIT to your tactical plan. Hans Fogh reverse psychology: If you round and immediately jibe away from fleet (even if uncomfortable), others often follow thinking you have local knowledge. Use this to maintain your phase. "Confidence in execution creates tactical opportunities."',
        champion_story:
          'Hans Fogh (Olympic Gold, Star World Champion): After mark rounding, confidently sail chosen direction even if fleet goes opposite way. Confidence convinces others you know something they don\'t. Often fleet follows, giving you tactical control.',

        confidence: 90,
        impact: 'medium',
        next_race_focus:
          'After rounding on lifted, commit to the corresponding jibe with confidence. Resist fleet pressure. Practice Hans Fogh reverse.',
        demo_reference: './bill-demo 6',
      };
    }

    if (!isLifted && inPhase === false) {
      return {
        phase: 'windward_mark',
        bill_framework: 'Getting In Phase',
        your_approach: 'You rounded on the headed tack and felt out of phase',
        bill_recommendation:
          'üéØ This is exactly what Bill warns about! "Round on the HEADED tack and you start downwind out of phase." Next race: as you approach windward mark, check your compass. If headed, consider tacking before mark to round on the LIFTED tack instead. Sets up entire downwind leg!',

        // Colgate Execution Analysis
        colgate_execution_technique: 'Pre-Mark Tactical Decision Making',
        execution_score: 60,
        execution_feedback:
          'üìö Steve Colgate: Championship sailors make mark approach decisions early, not at the mark. Starting 4-5 boat lengths away: (1) Check compass, (2) Assess tactical situation, (3) Decide tack or round as-is, (4) Execute decision smoothly. If headed and space available, tack away and re-approach on lifted. This prevents being forced into bad tactical position.',

        confidence: 90,
        impact: 'high',
        next_race_focus:
          'Check compass approaching windward mark 4-5 lengths away. Tack if needed to round on lifted. Practice early decision making.',
        demo_reference: './bill-demo 6',
      };
    }

    return {
      phase: 'windward_mark',
      bill_framework: 'Getting In Phase',
      your_approach: `You rounded on ${approach}${inPhase !== undefined ? ` and felt ${inPhase ? 'in' : 'out of'} phase` : ''}`,
      bill_recommendation:
        'üí° Bill Gladstone teaches: "Round windward mark on the LIFTED tack." Check compass as you approach - if you\'re headed, consider tacking before the mark to round on the lifted tack. This sets you up "in phase" for the downwind leg.',

      // Colgate Execution Analysis
      colgate_execution_technique: 'Mark Approach Awareness (Foundation)',
      execution_score: 70,
      execution_feedback:
        'üìö Steve Colgate: Build mark approach discipline starting now. Simple routine: 5 boat lengths from mark ‚Üí check compass ‚Üí assess if lifted/headed ‚Üí decide tack or round ‚Üí execute. This 4-step routine becomes automatic with practice. "Championship mark roundings start with early awareness, not last-second reactions."',

      confidence: 90,
      impact: 'medium',
      next_race_focus:
        'Practice checking compass on windward mark approach 5 lengths away - tack if needed to round lifted. Build the routine.',
      demo_reference: './bill-demo 6',
    };
  }

  /**
   * Analyze Covering/Breaking Cover Tactics (Colgate Specialty)
   * NEW in Phase 3: Analyzes tactical situations using Colgate's champion techniques
   */
  private analyzeCoveringTactics(analysis: RaceAnalysis): CoachingFeedback | null {
    // Check if sailor described any covering or breaking cover situations
    const notes = analysis.key_takeaways?.toLowerCase() || '';
    const hasCoveringMention =
      notes.includes('cover') ||
      notes.includes('tack') ||
      notes.includes('opponent') ||
      notes.includes('leading') ||
      notes.includes('behind');

    if (!hasCoveringMention) {
      return null; // No covering situation to analyze
    }

    // Determine if they were covering or being covered based on position
    const wasLeading = notes.includes('lead') || notes.includes('ahead') || notes.includes('first');
    const wasTrailing = notes.includes('behind') || notes.includes('catch');

    if (wasLeading) {
      // They were leading - analyze covering technique
      return {
        phase: 'upwind',
        bill_framework: 'Delayed Tack',
        your_approach: 'You were leading and covering opponents',
        bill_recommendation:
          'üèÜ Bill Gladstone: After crossing opponent, use DELAYED TACK to maximize geometric advantage. Cross ‚Üí sail <1 length ‚Üí tack.',

        // Colgate Covering Execution
        colgate_execution_technique: 'Tight Cover Timing + Loose Cover Herding',
        execution_score: 80,
        execution_feedback:
          'üéØ Steve Colgate covering mastery: TIGHT COVER when opponent sailing away from fleet - tack dead upwind after crossing with perfect timing (too late = safe leeward for them, too early = safe leeward when they tack). LOOSE COVER when going same direction as fleet - stay between opponent and finish but give clear air so they don\'t tack away. "Herding them where you want to go."',
        champion_story:
          'Colgate principle: "Many races lost by NOT covering when chance exists. After crossing on starboard near finish, tack IMMEDIATELY to cover - splitting tacks very risky with wind shifts."',

        confidence: 85,
        impact: 'high',
        next_race_focus:
          'When leading: Practice tight cover timing. Tack right location/moment to be dead on their wind by momentum pickup.',
      };
    }

    if (wasTrailing) {
      // They were trailing - analyze breaking cover technique
      const tackCount = (notes.match(/tack/g) || []).length;
      const multipleHitches = tackCount >= 3;

      return {
        phase: 'upwind',
        bill_framework: 'Wind Shift Mathematics',
        your_approach: multipleHitches
          ? `You tacked ${tackCount}+ times trying to break cover`
          : 'You tried to break cover from opponent',
        bill_recommendation:
          'üí° Bill: "10¬∞ shift = 25% leverage. Wind shifts hit windward boat first." Use shift advantage to break cover.',

        // Colgate Breaking Cover Execution
        colgate_execution_technique: multipleHitches
          ? 'Three Tacks Rule (Colgate) ‚úÖ'
          : 'Dick Stearns Shift Watching',
        execution_score: multipleHitches ? 85 : 70,
        execution_feedback: multipleHitches
          ? 'üèÜ Excellent persistence! Steve Colgate: "Never give up after 2 tacks. Usually break away after THIRD tack - magic number is THREE." Opponent decides tacking duel not worth distance to others. You showed championship-level determination!'
          : 'üéØ Dick Stearns technique for breaking cover: Watch covering boat\'s HULL ANGLE. When they appear LIFTED, tack immediately. When they tack to cover, they\'re in HEADER. Wind shift takes moments to travel down - you have heading advantage until reaches you. Practice this!',
        champion_story: multipleHitches
          ? 'Colgate: "Covered boat has choice of WHEN to tack, covering boat only reacts. By watching wave patterns, covered boat can choose smooth patch to accelerate rapidly. Covering boat tacks on reaction, often in worse conditions."'
          : 'Dick Stearns vs Tom Blackaller (Bacardi Cup Star Series): Dick watched Tom\'s Star hull angle. When Tom lifted, Dick tacked. Tom tacked to cover but was in header. Shifty 15 mph offshore - Dick had heading advantage until shift reached him. Repeated over and over, ate up Tom\'s lead. 90% confidence!',

        confidence: multipleHitches ? 85 : 90,
        impact: 'high',
        next_race_focus: multipleHitches
          ? 'Combine three tacks rule with shift watching - time your tacks when covering boat gets lifted'
          : 'Practice Dick Stearns shift watching: Watch their hull, tack when they lift, gain heading advantage',
      };
    }

    return null;
  }

  /**
   * Generate overall assessment using Claude with Bill's frameworks
   */
  private async generateOverallAssessment(
    analysis: RaceAnalysis,
    feedback: CoachingFeedback[],
    scores: FrameworkScores,
    race: Race
  ): Promise<string> {
    // Build context from analysis
    const context = this.buildAnalysisContext(analysis, race);

    const prompt = `You are Bill Gladstone from North U, reviewing a sailor's post-race analysis.

RACE CONTEXT:
${context}

FRAMEWORK SCORES:
${JSON.stringify(scores, null, 2)}

SPECIFIC FEEDBACK GIVEN:
${feedback.map((f) => `${f.phase}: ${f.bill_recommendation}`).join('\n')}

Provide a 2-3 paragraph overall assessment in Bill's teaching style:
1. Recognize what they did well (specific frameworks they used correctly)
2. Identify the #1 priority for improvement
3. End with Bill's characteristic encouragement and specific next steps

Use Bill's voice: quantified, tactical, encouraging, with his signature phrases when appropriate.`;

    const response = await this.anthropic.messages.create({
      model: 'claude-3-5-sonnet-latest',
      max_tokens: 512,
      temperature: 0.7,
      messages: [{ role: 'user', content: prompt }],
    });

    return response.content[0].type === 'text' ? response.content[0].text : '';
  }

  /**
   * Build analysis context for Claude
   */
  private buildAnalysisContext(analysis: RaceAnalysis, race: Race): string {
    const lines: string[] = [];

    lines.push(`Race: ${race.name}`);
    if (analysis.overall_satisfaction) {
      lines.push(`Overall satisfaction: ${analysis.overall_satisfaction}/5`);
    }

    if (analysis.upwind_puff_handling) {
      lines.push(`Puff handling: ${analysis.upwind_puff_handling}`);
    }

    if (analysis.upwind_tactics_used?.length) {
      lines.push(`Tactics used: ${analysis.upwind_tactics_used.join(', ')}`);
    }

    if (analysis.upwind_shift_awareness) {
      lines.push(`Shift awareness: ${analysis.upwind_shift_awareness}/5`);
    }

    if (analysis.downwind_shift_detection) {
      lines.push(`Downwind detection: ${analysis.downwind_shift_detection}`);
    }

    if (analysis.windward_mark_approach_tack) {
      lines.push(`Windward mark approach: ${analysis.windward_mark_approach_tack}`);
    }

    if (analysis.downwind_in_phase !== undefined) {
      lines.push(`Downwind in phase: ${analysis.downwind_in_phase}`);
    }

    if (analysis.key_learnings?.length) {
      lines.push(`Key learnings: ${analysis.key_learnings.join('; ')}`);
    }

    return lines.join('\n');
  }

  /**
   * Prioritize next race focus areas
   */
  private prioritizeNextRaceFocus(
    feedback: CoachingFeedback[],
    scores: FrameworkScores
  ): string[] {
    // Sort feedback by impact and low scores
    const highImpact = feedback.filter((f) => f.impact === 'high');

    // Identify lowest scores
    const scoreEntries = Object.entries(scores)
      .filter(([key]) => key !== 'overall_framework_adoption')
      .sort((a, b) => (a[1] as number) - (b[1] as number));

    const priorities: string[] = [];

    // Add high-impact items first
    highImpact.slice(0, 2).forEach((f) => {
      priorities.push(f.next_race_focus);
    });

    // Add lowest-scoring framework if not already included
    if (scoreEntries.length > 0 && priorities.length < 3) {
      const lowestFramework = scoreEntries[0][0];
      const correspondingFeedback = feedback.find((f) => {
        const frameworkKey = this.frameworkToScoreKey(f.bill_framework);
        return frameworkKey === lowestFramework;
      });

      if (correspondingFeedback && !priorities.includes(correspondingFeedback.next_race_focus)) {
        priorities.push(correspondingFeedback.next_race_focus);
      }
    }

    return priorities.slice(0, 3); // Top 3 priorities
  }

  /**
   * Map framework name to score key
   */
  private frameworkToScoreKey(framework: BillGladstoneFramework): keyof FrameworkScores {
    const mapping: Record<BillGladstoneFramework, keyof FrameworkScores> = {
      'Puff Response Framework': 'puff_response',
      'Delayed Tack': 'delayed_tack_usage',
      'Wind Shift Mathematics': 'shift_awareness',
      'Shift Frequency Formula': 'shift_awareness',
      'Downwind Shift Detection': 'downwind_detection',
      'Getting In Phase': 'getting_in_phase',
      'Performance Pyramid': 'overall_framework_adoption',
    };

    return mapping[framework];
  }

  /**
   * Score calculation methods
   */

  private calculatePuffResponseScore(handling: string): number {
    const scores: Record<string, number> = {
      traveler: 95,
      mainsheet: 70,
      feathered: 30,
      not_sure: 20,
    };
    return scores[handling] || 50;
  }

  private calculateDelayedTackScore(tactics: string[]): number {
    if (tactics.includes('delayed_tack')) return 95;
    if (tactics.includes('cross_and_cover')) return 60;
    if (tactics.length > 0) return 40;
    return 20;
  }

  private calculateDownwindDetectionScore(method: string): number {
    const scores: Record<string, number> = {
      apparent_wind: 95,
      schooled_upwind_boats: 70,
      compass: 60,
      didnt_track: 20,
    };
    return scores[method] || 40;
  }

  private calculateInPhaseScore(
    approach: string,
    inPhase?: boolean
  ): number {
    const isLifted = approach.includes('lifted');

    if (isLifted && inPhase === true) return 95;
    if (isLifted && inPhase === false) return 70;
    if (!isLifted && inPhase === false) return 30;
    if (!isLifted && inPhase === true) return 60; // Lucky but not good process

    return 50; // Not sure
  }

  /**
   * Load Bill Gladstone frameworks from skill files
   */
  private async loadBillGladstoneFrameworks(): Promise<void> {
    // In production, this would load from deployed Claude Skill
    // For now, we'll note that frameworks are loaded from skill files

    this.billFrameworks = {
      loaded: true,
      version: '1.0',
      frameworks: [
        'Puff Response Framework',
        'Delayed Tack',
        'Wind Shift Mathematics',
        'Downwind Shift Detection',
        'Getting In Phase',
      ],
    };
  }
}

interface BillGladstoneFrameworkData {
  loaded: boolean;
  version: string;
  frameworks: string[];
}
