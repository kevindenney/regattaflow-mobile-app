# Sign In Flow Test
# Tests sign in through Account modal using stable testIDs
appId: com.regattaflow.app
tags:
  - auth
  - critical
env:
  TEST_EMAIL: "demo-sailor@regattaflow.app"
  TEST_PASSWORD: ${DEMO_PASSWORD}
---

# Launch the app
- launchApp

# Wait for app to load
- extendedWaitUntil:
    visible: ".*"
    timeout: 15000

# Handle Expo dev launcher (dynamic host/port variants)
- tapOn:
    text: "RegattaFlow"
    optional: true
- tapOn:
    text: "http://10.0.2.2:8082"
    optional: true
- tapOn:
    text: "http://10.0.2.2:8081"
    optional: true
- tapOn:
    text: "http://localhost:8081"
    optional: true

# Wait for app to fully load
- extendedWaitUntil:
    visible: ".*"
    timeout: 20000

# Handle onboarding screens if they appear
- repeat:
    times: 8
    commands:
      - tapOn:
          text: "Continue"
          optional: true
      - tapOn:
          text: "Get Started"
          optional: true
      - tapOn:
          text: "Next"
          optional: true
      - tapOn:
          text: "Skip"
          optional: true

# Wait for UI to stabilize
- extendedWaitUntil:
    visible: ".*"
    timeout: 5000

# Navigate into Account then open Login
- openLink: "exp+regattaflow-app://account"
- extendedWaitUntil:
    visible: "Account"
    timeout: 10000
- tapOn:
    id: "account-sign-in-button"
- extendedWaitUntil:
    visible:
      id: "login-title"
    timeout: 20000
- assertVisible:
    id: "login-title"
- assertVisible:
    id: "login-identifier-input"
- assertVisible:
    id: "login-password-input"

# ============================================================
# CREDENTIAL ENTRY
# Note: TextInput testID selectors don't work reliably on iOS.
# Using coordinate-based input as fallback.
# ============================================================

# Enter email
- tapOn:
    id: "login-identifier-input"
- eraseText
- inputText: ${TEST_EMAIL}

# Hide keyboard for consistent positioning
- hideKeyboard

# Enter password
- tapOn:
    id: "login-password-input"
- eraseText
- inputText: ${TEST_PASSWORD}

# Hide keyboard
- hideKeyboard

# Tap Sign In button
- tapOn:
    id: "login-submit-button"

# ============================================================
# VERIFY SIGN IN SUCCESS
# ============================================================

# Wait for app to process login
- extendedWaitUntil:
    visible: ".*"
    timeout: 10000

# Wait for main app screen to appear after sign-in
- extendedWaitUntil:
    visible: "Race"
    timeout: 60000

- assertVisible: "Race"
